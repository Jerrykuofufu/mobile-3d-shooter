<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>Gravity Courier Run</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111;
      --muted:#667085;
      --stroke:rgba(17,17,17,.12);
      --shadow:0 18px 50px rgba(0,0,0,.10);
      --pill:#eef2ff;

      /* frame */
      --frame:#0b0f1a;
      --frameInner:#fff;
      --frameGlow:transparent;

      /* scene accent */
      --accent:#3b82f6;
      --accent2:#22c55e;

      /* neon */
      --neon1:#00e5ff;
      --neon2:#ff4dff;
      --neon3:#7c3aed;
    }

    /* Night */
    [data-theme="night"]{
      --bg:#0a0f1f;
      --card:#0f172a;
      --ink:#f8fafc;
      --muted:#cbd5e1;
      --stroke:rgba(255,255,255,.12);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --pill:rgba(255,255,255,.08);

      --frame:#0b1020;
      --frameInner:#0b1020;
      --accent:#60a5fa;
      --accent2:#34d399;
    }

    /* Neon */
    [data-theme="neon"]{
      --bg:#05040a;
      --card:rgba(12, 11, 22, .78);
      --ink:#f8fafc;
      --muted:#b8b6c9;
      --stroke:rgba(255,255,255,.10);
      --shadow:0 18px 70px rgba(0,0,0,.75);
      --pill:rgba(255,255,255,.08);

      --frame:#05040a;
      --frameInner:#05040a;
      --frameGlow:rgba(0,229,255,.18);
      --accent:var(--neon1);
      --accent2:var(--neon2);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial;
      background:radial-gradient(1200px 500px at 10% 0%, rgba(59,130,246,.10), transparent 55%),
                 radial-gradient(900px 400px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
                 var(--bg);
      color:var(--ink);
    }
    [data-theme="neon"] body{
      background:
        radial-gradient(900px 380px at 15% 10%, rgba(0,229,255,.18), transparent 55%),
        radial-gradient(900px 420px at 85% 20%, rgba(255,77,255,.14), transparent 55%),
        radial-gradient(800px 500px at 60% 110%, rgba(124,58,237,.12), transparent 55%),
        var(--bg);
    }

    .wrap{max-width:920px;margin:14px auto;padding:0 14px 30px}
    .topRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin:8px 0 10px;
    }
    h1{
      margin:8px 0 2px;
      font-size:38px;
      letter-spacing:.5px;
      display:flex;align-items:center;gap:10px;
    }
    .chip{
      background:var(--pill);
      border:1px solid var(--stroke);
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
    }
    .chip b{color:var(--ink)}
    .panel{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* ç²¾ç·»å¤–æ¡†ï¼šé›™å±¤ + éœ“è™¹å‹•æ…‹ */
    .frame{
      position:relative;
      border-radius:22px;
      padding:10px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.35)),
        radial-gradient(700px 180px at 50% -30%, rgba(59,130,246,.15), transparent 60%);
      border:1px solid var(--stroke);
      overflow:hidden;
    }
    [data-theme="night"] .frame{
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)),
        radial-gradient(700px 180px at 50% -30%, rgba(96,165,250,.15), transparent 60%);
    }
    [data-theme="neon"] .frame{
      background:
        radial-gradient(700px 260px at 50% -40%, rgba(0,229,255,.12), transparent 60%),
        radial-gradient(700px 260px at 10% 120%, rgba(255,77,255,.10), transparent 60%),
        rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 0 0 1px rgba(0,229,255,.15), 0 0 35px rgba(0,229,255,.12), 0 0 50px rgba(255,77,255,.10);
    }
    .frame:before{
      content:"";
      position:absolute;inset:-2px;
      border-radius:24px;
      pointer-events:none;
      background:linear-gradient(90deg, rgba(59,130,246,.28), rgba(34,197,94,.22), rgba(59,130,246,.28));
      opacity:.35;
      filter: blur(10px);
    }
    [data-theme="neon"] .frame:before{
      opacity:.65;
      background:linear-gradient(90deg, rgba(0,229,255,.55), rgba(255,77,255,.48), rgba(124,58,237,.40), rgba(0,229,255,.55));
      animation: neonFlow 2.6s linear infinite;
      filter: blur(12px);
    }
    @keyframes neonFlow{
      0%{transform:translateX(-12%)}
      100%{transform:translateX(12%)}
    }

    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius:16px;
      background:var(--frameInner);
      border:2px solid rgba(0,0,0,.06);
    }
    [data-theme="night"] canvas{border:2px solid rgba(255,255,255,.08)}
    [data-theme="neon"] canvas{border:2px solid rgba(0,229,255,.22); box-shadow: 0 0 18px rgba(0,229,255,.10) inset;}

    .bar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px;
    }
    .stats{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;
      color:var(--muted);
      font-size:14px;
    }
    .stats b{color:var(--ink);font-weight:800}
    .btns{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    }
    button, input, select{
      font:inherit;
    }
    button{
      padding:10px 14px;
      border-radius:14px;
      border:2px solid rgba(17,17,17,.45);
      background:#fff;
      color:#111;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    [data-theme="night"] button,[data-theme="neon"] button{
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border:2px solid rgba(255,255,255,.20);
    }
    button.ghost{
      border-style:dashed;
      opacity:.95;
    }
    button.primary{
      border-color:rgba(59,130,246,.65);
    }
    [data-theme="neon"] button.primary{
      border-color:rgba(0,229,255,.55);
      box-shadow: 0 0 14px rgba(0,229,255,.16);
    }

    input{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:transparent;
      color:var(--ink);
      min-width:180px;
      outline:none;
    }
    input::placeholder{color:var(--muted)}

    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:14px;
    }
    @media (min-width:860px){
      .twoCol{grid-template-columns: 1.35fr .65fr}
    }

    .lb{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .lb h2{
      margin:0 0 10px;
      font-size:16px;
      display:flex;align-items:center;gap:8px;
    }
    .grid{
      display:grid;
      grid-template-columns: 42px 1fr 90px;
      gap:8px;
      align-items:center;
      font-size:14px;
    }
    .grid .head{
      color:var(--muted);
      font-weight:800;
      padding:6px 0;
      border-bottom:1px solid var(--stroke);
      margin-bottom:6px;
    }
    .row{
      padding:6px 0;
      border-bottom:1px dashed var(--stroke);
    }
    .row:last-child{border-bottom:none}
    .muted{color:var(--muted); font-size:12px; line-height:1.35}
    .rankLine{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }

    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.55);
      color:var(--muted);
      font-size:12px;
    }
    [data-theme="night"] .toast,[data-theme="neon"] .toast{
      background:rgba(255,255,255,.06);
    }
  </style>
</head>

<body>
  <div class="wrap" id="app" data-theme="morning">
    <div class="topRow">
      <div>
        <h1>ğŸ›µ Gravity Courier Run</h1>
        <div class="chip">é»ä¸€ä¸‹ç¿»è½‰é‡åŠ›ï½œ<b>æ‰‹æ©Ÿè¶…é †</b>ï½œCombo è¶Šé«˜åŠ åˆ†è¶Šé¦™ ğŸ•</div>
      </div>

      <div class="btns">
        <button class="ghost" id="themeBtn">Scene: Morning</button>
        <button class="ghost" id="pwaBtn">ï¼‹åŠ åˆ°ä¸»ç•«é¢</button>
      </div>
    </div>

    <div class="panel">
      <div class="frame">
        <canvas id="c" width="900" height="260"></canvas>
      </div>

      <div class="bar">
        <div class="stats">
          <span>Score: <b id="score">0</b></span>
          <span>Best: <b id="best">0</b></span>
          <span>Combo: <b id="combo">0</b></span>
          <span>Speed: <b id="speed">1.0</b></span>
        </div>

        <div class="btns">
          <input id="name" maxlength="12" placeholder="Name (â‰¤12)" />
          <button class="primary" id="restart">é‡æ–°é–‹å§‹</button>
          <button class="ghost" id="sfxBtn">SFX: ON</button>
          <button class="ghost" id="bgmBtn">BGM: OFF</button>
        </div>
      </div>

      <div class="toast" id="tip">
        æ“ä½œï¼šé»ä¸€ä¸‹ / ç©ºç™½éµ = ç¿»è½‰é‡åŠ›ï¼ˆåœ°æ¿â‡„å¤©èŠ±æ¿ï¼‰ï½œä¸éœ€è¦é•·æŒ‰ï¼Œç¯€å¥é»é»é»å°±è¡Œ ğŸ˜¼
      </div>
    </div>

    <div class="twoCol">
      <div class="lb">
        <h2>ğŸ† ä¸–ç•Œæ’å <small id="rankHint" class="muted">è¼‰å…¥ä¸­â€¦</small></h2>

        <div class="grid head">
          <div>#</div><div>åå­—</div><div style="text-align:right">åˆ†æ•¸</div>
        </div>

        <div id="lbRows" class="grid"></div>

        <div class="rankLine" id="myRank">ä½ çš„ä¸–ç•Œæ’åï¼š-</div>
        <div class="muted">ï¼ˆåŒååªé¡¯ç¤ºæœ€é«˜åˆ†ï¼›Game Over æœƒé€å‡ºæˆç¸¾ï¼‰</div>
      </div>

      <div class="lb">
        <h2>âœ¨ ç‰¹è‰²ï¼ˆå…¨åŠ ï¼‰</h2>
        <div class="muted">
          âœ… æ—©ä¸Š/æ™šä¸Š/éœ“è™¹ ä¸‰å ´æ™¯<br/>
          âœ… ç²¾ç·»å¤–æ¡†ï¼ˆéœ“è™¹æœƒæµå‹•ï¼‰<br/>
          âœ… ä¸–ç•Œæ’è¡Œæ¦œï¼ˆå¯ç”¨ Apps Scriptï¼‰<br/>
          âœ… PWAï¼ˆå¯åŠ åˆ°ä¸»ç•«é¢ï¼‰<br/>
          âœ… é›¢ç·šå¯ç©ï¼ˆService Workerï¼‰<br/>
        </div>
        <div class="muted" style="margin-top:10px">
          âš ï¸ å¦‚æœä½ çš„æ’è¡Œæ¦œ API é‚„æ²’æ”¾ï¼Œæœƒå…ˆç”¨ã€Œæœ¬æ©Ÿæ’è¡Œæ¦œã€é ‚è‘—è·‘ï¼ˆä½ ä¸€æ¨£èƒ½ç©ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 1) ä½ çš„ä¸–ç•Œæ’è¡Œæ¦œ API
     *    å¦‚æœä½ æœ‰ Apps Scriptï¼šæŠŠ URL è²¼é€²ä¾†
     *    æ²’æœ‰ä¹Ÿæ²’é—œä¿‚ï¼šæœƒé€€å› localStorage æ’è¡Œæ¦œ
     ***********************/
    const LEADERBOARD_URL = ""; // <-- æŠŠä½ çš„ Apps Script Web App URL è²¼åœ¨é€™è£¡ï¼ˆå¯ç•™ç©ºï¼‰
    // å»ºè­° Apps Script æ”¯æ´ï¼š
    // GET  => å›å‚³ JSON: { top:[{name,score}], me:{rank,score,name}? } æˆ–ç›´æ¥å›å‚³é™£åˆ—ä¹Ÿè¡Œ
    // POST => body: {name, score} å›å‚³ JSON: { ok:true, rank:number, top:[...] }

    /***********************
     * 2) DOM
     ***********************/
    const app = document.getElementById("app");
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha:false });

    const scoreEl = document.getElementById("score");
    const bestEl  = document.getElementById("best");
    const comboEl = document.getElementById("combo");
    const speedEl = document.getElementById("speed");

    const nameEl = document.getElementById("name");
    const restartBtn = document.getElementById("restart");
    const sfxBtn = document.getElementById("sfxBtn");
    const bgmBtn = document.getElementById("bgmBtn");
    const themeBtn = document.getElementById("themeBtn");
    const pwaBtn = document.getElementById("pwaBtn");

    const lbRows = document.getElementById("lbRows");
    const rankHint = document.getElementById("rankHint");
    const myRankEl = document.getElementById("myRank");

    /***********************
     * 3) å­˜æª” Key
     ***********************/
    const KEY_BEST = "gcr_best";
    const KEY_NAME = "gcr_name";
    const KEY_THEME = "gcr_theme";
    const KEY_LB_LOCAL = "gcr_local_lb"; // fallback

    /***********************
     * 4) éŠæˆ²è¨­å®š
     ***********************/
    const W = canvas.width;
    const H = canvas.height;

    // è§’è‰²ï¼ˆå¤–é€å°æ©Ÿè»Šï¼‰
    const rider = {
      x: 140,
      y: H - 46,
      w: 44,
      h: 28,
      vy: 0,
      g: 0.68,
      gravityDir: 1,  // 1=å¾€ä¸‹  -1=å¾€ä¸Š
      lockFlip: 0
    };

    // ä¸–ç•Œ
    let state = "idle"; // idle | running | dead
    let tPrev = performance.now();
    let score = 0;
    let best = Number(localStorage.getItem(KEY_BEST) || 0);
    let combo = 0;
    let speed = 1.0;     // æœƒéš¨æ™‚é–“æ…¢æ…¢åŠ 
    let scroll = 0;

    // éšœç¤™ç‰©ï¼ˆä¸Šä¸‹éƒ½æœ‰ï¼‰
    let obstacles = [];
    let spawnTimer = 0;

    // å ´æ™¯ï¼ˆmorning / night / neonï¼‰
    const themes = ["morning","night","neon"];
    let themeIdx = themes.indexOf(localStorage.getItem(KEY_THEME) || "morning");
    if (themeIdx < 0) themeIdx = 0;
    setTheme(themes[themeIdx]);

    // éŸ³æ•ˆ/éŸ³æ¨‚
    let sfxEnabled = true;
    let bgmEnabled = false;
    let audioUnlocked = false;
    let audioCtx = null;
    let bgmOsc = null;
    let bgmGain = null;

    // PWA install
    let deferredPrompt = null;

    // UI init
    bestEl.textContent = best.toString();
    nameEl.value = (localStorage.getItem(KEY_NAME) || "Milo").slice(0,12);

    /***********************
     * 5) å·¥å…·ï¼šéŸ³æ•ˆï¼ˆç°¡å–®åˆæˆï¼Œæ‰‹æ©Ÿä¹Ÿèƒ½æ’­ï¼‰
     ***********************/
    function unlockAudio(){
      if (audioUnlocked) return;
      audioUnlocked = true;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function beep({freq=440, dur=0.08, type="sine", vol=0.12, slide=0, noise=false}={}){
      if (!sfxEnabled) return;
      unlockAudio();
      const now = audioCtx.currentTime;

      if (noise){
        // ç™½å™ªéŸ³ï¼ˆçˆ†ç‚¸/ç¢°æ’ç”¨ï¼‰
        const bufferSize = Math.floor(audioCtx.sampleRate * dur);
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(vol, now);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        src.connect(gain).connect(audioCtx.destination);
        src.start(now);
        return;
      }

      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, now);
      if (slide) o.frequency.exponentialRampToValueAtTime(freq*slide, now + dur);

      g.gain.setValueAtTime(vol, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

      o.connect(g).connect(audioCtx.destination);
      o.start(now);
      o.stop(now + dur);
    }

    function startBGM(){
      if (!bgmEnabled) return;
      unlockAudio();
      stopBGM();

      bgmOsc = audioCtx.createOscillator();
      bgmGain = audioCtx.createGain();

      bgmOsc.type = "triangle";
      bgmOsc.frequency.setValueAtTime(110, audioCtx.currentTime);
      bgmGain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      bgmGain.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 0.2);

      bgmOsc.connect(bgmGain).connect(audioCtx.destination);
      bgmOsc.start();

      // å°å°å¾‹å‹•
      let step = 0;
      const seq = [110, 131, 147, 131, 165, 147, 131, 110];
      const timer = setInterval(()=>{
        if (!bgmOsc) { clearInterval(timer); return; }
        const f = seq[step++ % seq.length];
        bgmOsc.frequency.setTargetAtTime(f, audioCtx.currentTime, 0.02);
      }, 240);
      bgmOsc._timer = timer;
    }

    function stopBGM(){
      if (bgmOsc){
        try{
          clearInterval(bgmOsc._timer);
          bgmGain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
          bgmOsc.stop(audioCtx.currentTime + 0.12);
        }catch(e){}
      }
      bgmOsc = null;
      bgmGain = null;
    }

    /***********************
     * 6) éŠæˆ²æ©Ÿåˆ¶ï¼šç¿»è½‰é‡åŠ›
     ***********************/
    function flipGravity(){
      if (state !== "running") return;
      if (rider.lockFlip > 0) return;

      rider.gravityDir *= -1;
      rider.lockFlip = 0.08; // é˜²æŠ–
      // ç¿»è½‰éŸ³æ•ˆï¼šä¹¾æ·¨ä¿è½ã€æ¯”ä¹‹å‰æ›´åƒã€Œç¿»è½‰ã€
      beep({freq: 740, dur: 0.06, type:"sine", vol:0.11, slide:0.75});
      beep({freq: 420, dur: 0.07, type:"triangle", vol:0.08});
    }

    function restart(){
      state = "running";
      score = 0;
      combo = 0;
      speed = 1.0;
      scroll = 0;
      obstacles = [];
      spawnTimer = 0;

      rider.gravityDir = 1;
      rider.vy = 0;
      rider.y = H - 46;

      // é‡æ–°é–‹å§‹ä¸è¦ã€Œé¦¬ä¸Šåˆ¤å®šæ­»ã€ï¼šçµ¦çŸ­ä¿è­·
      rider.lockFlip = 0.15;

      scoreEl.textContent = "0";
      comboEl.textContent = "0";
      speedEl.textContent = "1.0";

      if (bgmEnabled) startBGM();

      // ç”¢ç”Ÿç¬¬ä¸€æ³¢éšœç¤™ï¼Œé¿å…ã€Œç©ºä¸€å¤§æ®µã€
      for (let i=0;i<3;i++){
        spawnObstacle(true);
      }
    }

    /***********************
     * 7) éšœç¤™ç”Ÿæˆï¼ˆä¸Š/ä¸‹éš¨æ©Ÿï¼‰
     ***********************/
    function spawnObstacle(initial=false){
      // åŸºæœ¬é–“è·ï¼šè¶Šå¾Œé¢è¶Šå¿«ï¼Œä½†ä¸è¦å¤ªå…‡
      const baseGap = 260;                 // åŸºæœ¬ç©ºéš™
      const extra = Math.random()*180;     // éš¨æ©ŸåŠ å¤§
      const gap = baseGap + extra + (initial? 120 : 0) + Math.max(0, (1.4-speed)*80);

      const lastX = obstacles.length ? obstacles[obstacles.length-1].x : (W + 100);
      const x = Math.max(W + 40, lastX + gap);

      // ä¸Šæˆ–ä¸‹éšœç¤™
      const top = Math.random() < 0.5;
      const w = 20 + Math.random()*20;
      const h = 34 + Math.random()*60;

      obstacles.push({
        x, w, h, top,
        passed:false
      });
    }

    /***********************
     * 8) ç¢°æ’
     ***********************/
    function rectHit(ax,ay,aw,ah, bx,by,bw,bh){
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function gameOver(){
      if (state !== "running") return;
      state = "dead";
      stopBGM();

      // ç¢°æ’éŸ³+å°çˆ†ç‚¸ï¼ˆå™ªéŸ³+ä½é »ï¼‰
      beep({noise:true, dur:0.14, vol:0.22});
      beep({freq:140, dur:0.12, type:"sawtooth", vol:0.10, slide:0.55});

      // best
      if (score > best){
        best = score;
        localStorage.setItem(KEY_BEST, best.toString());
        bestEl.textContent = best.toString();
      }

      // é€å‡ºæ’è¡Œ
      submitScore();
    }

    /***********************
     * 9) æ’è¡Œæ¦œï¼šæœ¬æ©Ÿ fallback + é ç«¯ï¼ˆApps Scriptï¼‰
     ***********************/
    function getLocalLB(){
      try{
        return JSON.parse(localStorage.getItem(KEY_LB_LOCAL) || "[]") || [];
      }catch(e){
        return [];
      }
    }
    function setLocalLB(arr){
      localStorage.setItem(KEY_LB_LOCAL, JSON.stringify(arr.slice(0,50)));
    }

    function upsertLocalScore(name, sc){
      const lb = getLocalLB();
      const i = lb.findIndex(r => r.name === name);
      if (i >= 0) lb[i].score = Math.max(lb[i].score, sc);
      else lb.push({name, score: sc});
      lb.sort((a,b)=>b.score-a.score);
      setLocalLB(lb);
      const rank = lb.findIndex(r=>r.name===name) + 1;
      return { top: lb.slice(0,10), rank };
    }

    function renderLB(top, rank){
      lbRows.innerHTML = "";
      if (!top || !top.length){
        lbRows.innerHTML = `<div class="muted">â€”</div><div class="muted">æš«ç„¡è³‡æ–™</div><div class="muted" style="text-align:right">â€”</div>`;
        myRankEl.textContent = `ä½ çš„ä¸–ç•Œæ’åï¼š${rank || "-"}`;
        rankHint.textContent = "ï¼ˆæ²’æœ‰è³‡æ–™ï¼‰";
        return;
      }
      rankHint.textContent = "Top 10";
      top.forEach((r, idx)=>{
        const n = (r.name || "NONAME").toString().slice(0,12);
        const s = Number(r.score||0)|0;
        const a = document.createElement("div");
        a.className = "row";
        a.style.display = "contents";
        a.innerHTML = `
          <div class="row">${idx+1}</div>
          <div class="row">${escapeHtml(n)}</div>
          <div class="row" style="text-align:right;font-weight:900">${s}</div>
        `;
        lbRows.appendChild(a);
      });
      myRankEl.textContent = `ä½ çš„ä¸–ç•Œæ’åï¼š${rank || "-"}`;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    async function fetchTop(){
      // å…ˆç”¨é ç«¯ï¼Œå¦‚æœæ²’æœ‰å† fallback
      const nm = (nameEl.value || "Milo").trim().slice(0,12) || "Milo";

     
