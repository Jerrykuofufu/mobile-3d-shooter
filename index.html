<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Dinosaur Running</title>
  <style>
    html,body{margin:0;padding:0;overflow:hidden;background:#0b1020;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    canvas{display:block;touch-action:none}

    /* HUD */
    #hud{
      position:fixed;top:10px;left:10px;right:10px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      z-index:10;color:#fff;pointer-events:none;
    }
    .pill{
      pointer-events:none;
      display:inline-flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:999px;
      backdrop-filter: blur(6px);
      font-size:13px;
    }
    #hpWrap{width:min(240px,45vw);height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden}
    #hpBar{height:100%;width:100%;background:rgba(255,255,255,.9)}
    #mini{
      opacity:.85;font-size:12px
    }

    /* Crosshair */
    #crosshair{
      position:fixed;left:50%;top:50%;
      width:16px;height:16px;transform:translate(-50%,-50%);
      z-index:10;pointer-events:none;
    }
    #crosshair:before,#crosshair:after{
      content:"";position:absolute;left:50%;top:50%;
      background:rgba(255,255,255,.85);
      transform:translate(-50%,-50%);
      border-radius:2px;
    }
    #crosshair:before{width:14px;height:2px}
    #crosshair:after{width:2px;height:14px}

    /* Bottom UI */
    #ui{
      position:fixed;left:0;right:0;bottom:14px;
      display:flex;justify-content:space-between;align-items:flex-end;
      padding:0 14px;z-index:10;
      pointer-events:none;
    }

    /* Joystick */
    #joyWrap{
      pointer-events:auto;
      width:140px;height:140px;border-radius:24px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      position:relative;overflow:hidden;
    }
    #joyBase{
      position:absolute;left:50%;top:50%;
      width:92px;height:92px;border-radius:999px;
      transform:translate(-50%,-50%);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
    }
    #joyKnob{
      position:absolute;left:50%;top:50%;
      width:54px;height:54px;border-radius:999px;
      transform:translate(-50%,-50%);
      background:rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.20);
    }

    /* Right controls */
    #rightControls{
      pointer-events:auto;
      display:flex;flex-direction:column;gap:10px;align-items:flex-end;
    }
    .row{display:flex;gap:10px;justify-content:flex-end}
    .btn{
      border:none;border-radius:16px;
      padding:12px 16px;
      font-size:15px;font-weight:700;
      background:rgba(255,255,255,.92);
      color:#111; box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .btn.secondary{
      background:rgba(255,255,255,.10);
      color:#fff;border:1px dashed rgba(255,255,255,.30);
      box-shadow:none;
    }
    .btn.tiny{padding:10px 12px;font-size:13px;border-radius:14px}
    .btn:active{transform:translateY(1px)}
    #shootBtn{padding:18px 22px;font-size:16px;border-radius:20px}

    /* Overlay */
    #overlay{
      position:fixed;inset:0;z-index:20;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1200px 800px at 50% 20%, rgba(255,255,255,.08), rgba(0,0,0,.65));
      color:#fff;
    }
    #card{
      width:min(520px,92vw);
      background:rgba(15,20,40,.72);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      padding:18px 16px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 50px rgba(0,0,0,.45);
    }
    #card h1{margin:0 0 8px;font-size:22px}
    #card p{margin:6px 0;color:rgba(255,255,255,.86);line-height:1.35}
    #card .tiny{margin-top:10px;font-size:12px;color:rgba(255,255,255,.70)}
    #card .row{justify-content:flex-start}
    #card .btn{pointer-events:auto}
    #nameRow{display:flex;gap:10px;align-items:center;margin-top:10px}
    #name{
      flex:1;
      padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);color:#fff;font-size:15px;outline:none;
    }
    #msg{margin-top:8px;font-size:13px;color:rgba(255,255,255,.82);min-height:18px}

    /* Right look zone hint (invisible but used for touch) */
    #lookZone{
      position:fixed;right:0;top:0;bottom:0;width:55vw;
      z-index:9; /* below ui but above canvas */
      pointer-events:auto;
      background:transparent;
      touch-action:none;
    }

    /* Small screens */
    @media (max-width:420px){
      #joyWrap{width:124px;height:124px}
      #shootBtn{padding:16px 18px}
      .btn{font-size:14px}
    }
  </style>
</head>
<body>
  <div id="hud">
    <div class="pill">
      <span>â¤ï¸</span>
      <div id="hpWrap"><div id="hpBar"></div></div>
      <span id="hpText">100</span>
    </div>
    <div class="pill" id="mini">
      <span>ğŸ¯ åˆ†æ•¸ï¼š<b id="score">0</b></span>
      <span>ğŸ’€ æ“Šæ®ºï¼š<b id="kills">0</b></span>
      <span>ğŸŒŠ æ³¢æ¬¡ï¼š<b id="wave">1</b></span>
      <span>ğŸ”« <b id="weaponName">æ‰‹æ§</b></span>
    </div>
    <div class="pill">
      <span>ğŸ”Š éŸ³æ•ˆï¼š<b id="sfxState">é–‹</b></span>
      <span>ğŸµ éŸ³æ¨‚ï¼š<b id="musicState">é–‹</b></span>
    </div>
  </div>

  <div id="crosshair"></div>
  <div id="lookZone" aria-label="look-zone"></div>

  <div id="ui">
    <div id="joyWrap" aria-label="joystick">
      <div id="joyBase"></div>
      <div id="joyKnob"></div>
    </div>

    <div id="rightControls">
      <div class="row">
        <button class="btn secondary tiny" id="pauseBtn">â¸ æš«åœ</button>
        <button class="btn secondary tiny" id="restartBtn">â†» é‡æ–°é–‹å§‹</button>
      </div>
      <div class="row">
        <button class="btn secondary tiny" id="sfxBtn">ğŸ”Š éŸ³æ•ˆï¼šé–‹</button>
        <button class="btn secondary tiny" id="musicBtn">ğŸµ éŸ³æ¨‚ï¼šé–‹</button>
      </div>
      <div class="row">
        <button class="btn secondary tiny" id="w1">æ‰‹æ§</button>
        <button class="btn secondary tiny" id="w2">æ©Ÿæ§</button>
        <button class="btn secondary tiny" id="w3">éœ°å½ˆ</button>
      </div>
      <button class="btn" id="shootBtn">ğŸ”« SHOOT</button>
    </div>
  </div>

  <div id="overlay">
    <div id="card">
      <h1>ğŸ¦– Dinosaur Runningï¼ˆ3D Shooterï¼‰</h1>
      <p>ğŸ“± å·¦ä¸‹æ–æ¡¿ç§»å‹•ï½œå³åŠé‚Šæ»‘å‹•è½‰è¦–è§’ï½œæŒ‰ SHOOT é–‹ç«</p>
      <p>ğŸ˜¼ å°å¿ƒæ–¹å¡Šæ•µäººæœƒè¿½ä½ ï½æ¯ 15 æ“Šæ®ºæœƒå‡º Bossï¼</p>
      <div id="nameRow">
        <input id="name" maxlength="12" value="Milo" placeholder="ä½ çš„åå­—ï¼ˆ12å­—ä»¥å…§ï¼‰"/>
        <button class="btn" id="startBtn">é–‹å§‹</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="resumeBtn" style="display:none">ç¹¼çºŒ</button>
      </div>
      <div class="tiny">æç¤ºï¼šæ‰‹æ©Ÿç€è¦½å™¨éœ€è¦ã€Œå…ˆé»ä¸€ä¸‹ã€æ‰å…è¨±æ’­æ”¾è²éŸ³ï¼ˆç³»çµ±è¦å‰‡ï¼‰ã€‚</div>
      <div id="msg"></div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

    // =========================
    //   Settings (mobile-friendly)
    // =========================
    const CFG = {
      moveSpeed: 5.2,
      sprintBoost: 1.0,
      friction: 11,
      lookSensitivity: 0.0065,     // touch look
      maxPitch: Math.PI * 0.48,
      bulletSpeed: 24,
      bulletLife: 1.0,
      enemyBaseSpeed: 2.0,
      enemySpawnRadius: 20,
      enemyDespawnRadius: 70,
      hitIFrames: 0.45,
      scorePerKill: 120,
      bossEveryKills: 15,
      waveKills: 10,               // each wave after 10 kills
      waveScale: 0.10,             // enemy speed/HP scaling
      maxEnemiesSoft: 14,          // keep performance
    };

    // =========================
    //   Audio (WebAudio synth)
    // =========================
    let audioCtx = null;
    let sfxEnabled = true;
    let musicEnabled = true;
    let musicNodes = null;

    function ensureAudio(){
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
      if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    }

    function beep(freq=520, ms=70, type="square", vol=0.05){
      if(!sfxEnabled) return;
      if(!audioCtx) return;
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(vol, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0); o.stop(t0 + ms/1000 + 0.02);
    }

    function startMusic(){
      if(!musicEnabled) return;
      if(!audioCtx) return;
      stopMusic();

      // Simple chilled loop: 2 oscillators + filter + gentle LFO
      const master = audioCtx.createGain();
      master.gain.value = 0.05;

      const filter = audioCtx.createBiquadFilter();
      filter.type = "lowpass";
      filter.frequency.value = 800;

      const o1 = audioCtx.createOscillator();
      const o2 = audioCtx.createOscillator();
      o1.type = "sine";
      o2.type = "triangle";
      o1.frequency.value = 196; // G3
      o2.frequency.value = 294; // D4

      const lfo = audioCtx.createOscillator();
      const lfoG = audioCtx.createGain();
      lfo.type = "sine";
      lfo.frequency.value = 0.12;
      lfoG.gain.value = 160; // mod filter
      lfo.connect(lfoG);
      lfoG.connect(filter.frequency);

      const pad = audioCtx.createGain();
      pad.gain.value = 1.0;

      o1.connect(pad); o2.connect(pad);
      pad.connect(filter);
      filter.connect(master);
      master.connect(audioCtx.destination);

      o1.start(); o2.start(); lfo.start();

      // tiny chord drift
      let step = 0;
      const seq = [
        [196, 294], // G-D
        [220, 330], // A-E
        [174, 262], // F-C
        [196, 294], // G-D
      ];
      const timer = setInterval(()=>{
        if(!audioCtx) return;
        const [a,b] = seq[step % seq.length];
        const t = audioCtx.currentTime;
        o1.frequency.linearRampToValueAtTime(a, t+0.25);
        o2.frequency.linearRampToValueAtTime(b, t+0.25);
        step++;
      }, 1800);

      musicNodes = { master, filter, o1, o2, lfo, lfoG, pad, timer };
    }

    function stopMusic(){
      if(!musicNodes) return;
      try{
        clearInterval(musicNodes.timer);
        musicNodes.o1.stop();
        musicNodes.o2.stop();
        musicNodes.lfo.stop();
      }catch(e){}
      musicNodes = null;
    }

    // =========================
    //   Renderer / Scene
    // =========================
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b1020, 18, 70);

    // Camera with yaw/pitch
    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 160);
    let yaw = 0, pitch = -0.08;

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x223355, 0.9);
    scene.add(hemi);

    const sun = new THREE.DirectionalLight(0xffffff, 1.0);
    sun.position.set(10, 18, 8);
    sun.castShadow = true;
    sun.shadow.mapSize.set(1024,1024);
    sun.shadow.camera.left = -25;
    sun.shadow.camera.right = 25;
    sun.shadow.camera.top = 25;
    sun.shadow.camera.bottom = -25;
    scene.add(sun);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(260, 260);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x11182e, roughness:1, metalness:0 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Simple arena border (visual)
    const ringGeo = new THREE.RingGeometry(22.8, 23.2, 64);
    const ringMat = new THREE.MeshBasicMaterial({ color:0xffffff, transparent:true, opacity:0.10, side:THREE.DoubleSide });
    const ring = new THREE.Mesh(ringGeo, ringMat);
    ring.rotation.x = -Math.PI/2;
    ring.position.y = 0.01;
    scene.add(ring);

    // Player (cute "dino-ish" capsule with one piece body)
    const player = new THREE.Group();
    const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness:0.95, metalness:0.0 });
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.45, 0.55, 8, 16), bodyMat);
    body.castShadow = true;
    body.position.y = 0.95;

    // "Head bump" to look more dino
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.34, 18, 18), bodyMat);
    head.castShadow = true;
    head.position.set(0.18, 1.22, 0.35);

    // Tail
    const tail = new THREE.Mesh(new THREE.ConeGeometry(0.22, 0.65, 14), bodyMat);
    tail.castShadow = true;
    tail.position.set(0.0, 0.95, -0.55);
    tail.rotation.x = Math.PI * 0.55;

    player.add(body, head, tail);
    player.position.set(0,0,0);
    scene.add(player);

    // Weapon muzzle helper
    const muzzle = new THREE.Object3D();
    muzzle.position.set(0.35, 1.15, 0.55);
    player.add(muzzle);

    // =========================
    //   UI references
    // =========================
    const $ = (id)=>document.getElementById(id);
    const hpBar = $("hpBar");
    const hpText = $("hpText");
    const scoreEl = $("score");
    const killsEl = $("kills");
    const waveEl = $("wave");
    const weaponNameEl = $("weaponName");
    const overlay = $("overlay");
    const startBtn = $("startBtn");
    const resumeBtn = $("resumeBtn");
    const pauseBtn = $("pauseBtn");
    const restartBtn = $("restartBtn");
    const sfxBtn = $("sfxBtn");
    const musicBtn = $("musicBtn");
    const sfxState = $("sfxState");
    const musicState = $("musicState");
    const lookZone = $("lookZone");
    const msgEl = $("msg");
    const nameInput = $("name");

    // Weapons
    const weapons = [
      { key:"pistol", name:"æ‰‹æ§",  cooldown:0.24, pellets:1, spread:0.002, damage:16, speed:CFG.bulletSpeed, color:0xffffff, kick:0.018 },
      { key:"smg",    name:"æ©Ÿæ§",  cooldown:0.09, pellets:1, spread:0.010, damage:8,  speed:CFG.bulletSpeed*1.05, color:0xffffff, kick:0.012 },
      { key:"shotgun",name:"éœ°å½ˆ",  cooldown:0.58, pellets:6, spread:0.040, damage:7,  speed:CFG.bulletSpeed*0.95, color:0xffffff, kick:0.028 },
    ];
    let weaponIndex = 0;

    function setWeapon(i){
      weaponIndex = Math.max(0, Math.min(weapons.length-1, i));
      weaponNameEl.textContent = weapons[weaponIndex].name;
      beep(660, 50, "square", 0.04);
      $("w1").style.opacity = weaponIndex===0? "1":"0.78";
      $("w2").style.opacity = weaponIndex===1? "1":"0.78";
      $("w3").style.opacity = weaponIndex===2? "1":"0.78";
    }

    $("w1").addEventListener("click", ()=>{ ensureAudio(); setWeapon(0); });
    $("w2").addEventListener("click", ()=>{ ensureAudio(); setWeapon(1); });
    $("w3").addEventListener("click", ()=>{ ensureAudio(); setWeapon(2); });

    // =========================
    //   State
    // =========================
    let state = "menu"; // menu | running | paused | gameover
    let hp = 100;
    let score = 0;
    let kills = 0;
    let wave = 1;
    let nextBossAt = CFG.bossEveryKills;
    let lastHitAt = -999;
    let timeAcc = 0;

    // difficulty scaling
    function diffMul(){
      return 1 + (wave-1)*CFG.waveScale;
    }

    // =========================
    //   Background "scene changes" (every 1000 score)
    // =========================
    const themes = [
      { name:"æ™¨å…‰", fog:0x0b1020, ground:0x11182e, skyTop:0x1d2a66, sun:1.0 },
      { name:"é»ƒæ˜", fog:0x160f1c, ground:0x241228, skyTop:0x5a2a3e, sun:0.85 },
      { name:"å¤œæ™š", fog:0x050812, ground:0x0a0f22, skyTop:0x081033, sun:0.65 },
    ];
    let themeIndex = 0;

    function applyTheme(i){
      themeIndex = ((i%themes.length)+themes.length)%themes.length;
      const t = themes[themeIndex];
      scene.fog.color.setHex(t.fog);
      ground.material.color.setHex(t.ground);
      renderer.setClearColor(new THREE.Color(t.fog), 1);
      sun.intensity = t.sun;
    }
    applyTheme(0);

    function updateThemeByScore(){
      const idx = Math.floor(score/1000);
      if(idx !== themeIndex) applyTheme(idx);
    }

    // =========================
    //   Bullets
    // =========================
    const bullets = [];
    const bulletGeo = new THREE.SphereGeometry(0.06, 10, 10);
    const bulletMat = new THREE.MeshStandardMaterial({ color:0xffffff, roughness:0.4, metalness:0.1 });

    function spawnBullet(origin, dir, speed){
      const m = new THREE.Mesh(bulletGeo, bulletMat);
      m.castShadow = true;
      m.position.copy(origin);
      scene.add(m);
      bullets.push({ mesh:m, vel:dir.clone().multiplyScalar(speed), life:CFG.bulletLife });
    }

    // =========================
    //   Enemies & Boss
    // =========================
    const enemies = [];
    const enemyGeo = new THREE.BoxGeometry(0.85, 0.85, 0.85);
    const enemyMat = new THREE.MeshStandardMaterial({ color:0xffffff, roughness:0.92, metalness:0.0 });

    const bossGeo = new THREE.BoxGeometry(2.0, 2.0, 2.0);
    const bossMat = new THREE.MeshStandardMaterial({ color:0xffffff, roughness:0.75, metalness:0.05 });

    function randRing(radius){
      const a = Math.random()*Math.PI*2;
      return new THREE.Vector3(Math.cos(a)*radius, 0, Math.sin(a)*radius);
    }

    function spawnEnemy(isBoss=false){
      const m = new THREE.Mesh(isBoss?bossGeo:enemyGeo, isBoss?bossMat:enemyMat);
      m.castShadow = true;
      m.receiveShadow = true;

      const r = CFG.enemySpawnRadius + Math.random()*10;
      const p = randRing(r);
      m.position.set(p.x, isBoss?1.0:0.55, p.z);
      scene.add(m);

      const baseHP = isBoss ? 240 : 40;
      const hpMul = diffMul();
      enemies.push({
        mesh:m,
        hp: Math.round(baseHP * hpMul),
        boss:isBoss,
        speed: (isBoss?1.55:CFG.enemyBaseSpeed) * (0.92 + Math.random()*0.22) * (0.95 + (wave-1)*0.06),
        touchDmg: isBoss? 18 : 10,
        knock: isBoss? 0.20 : 0.14,
      });
    }

    function softSpawnLogic(){
      const target = Math.min(CFG.maxEnemiesSoft, 3 + wave*2);
      const alive = enemies.filter(e=>e.hp>0).length;
      if(alive < target){
        // spawn 1â€“2
        const n = Math.random()<0.45 ? 2 : 1;
        for(let i=0;i<n;i++){
          if(enemies.length > 120) break;
          spawnEnemy(false);
        }
      }
    }

    // =========================
    //   Input: joystick + look + shoot
    // =========================
    const joyWrap = $("joyWrap");
    const joyKnob = $("joyKnob");
    let joyId = null;
    let joyCenter = {x:0,y:0};
    let joyVec = new THREE.Vector2(0,0);

    function setKnob(dx,dy){
      joyKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }

    function joyStart(e){
      const t = e.changedTouches[0];
      joyId = t.identifier;
      const rect = joyWrap.getBoundingClientRect();
      joyCenter.x = rect.left + rect.width/2;
      joyCenter.y = rect.top + rect.height/2;
      joyMove(e);
    }
    function joyMove(e){
      if(joyId===null) return;
      const t = [...e.changedTouches].find(x=>x.identifier===joyId);
      if(!t) return;
      const dx = t.clientX - joyCenter.x;
      const dy = t.clientY - joyCenter.y;
      const max = 42;
      const len = Math.hypot(dx,dy);
      const k = len>max ? max/len : 1;
      const nx = dx*k, ny = dy*k;
      setKnob(nx, ny);
      joyVec.set(nx/max, ny/max);
    }
    function joyEnd(e){
      const t = [...e.changedTouches].find(x=>x.identifier===joyId);
      if(!t) return;
      joyId = null;
      joyVec.set(0,0);
      setKnob(0,0);
    }
    joyWrap.addEventListener("t
