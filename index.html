<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Gravity Courier Run</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --ink:#111;
      --muted:#666;
      --card:#ffffff;
      --line:#d6d9e3;
      --shadow: 0 12px 30px rgba(20,20,40,.10);
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",Arial;}
    .wrap{max-width:920px;margin:14px auto;padding:0 14px;}
    h1{margin:6px 0 6px;font-size:36px;line-height:1.1;letter-spacing:.2px;}
    .sub{color:var(--muted);margin:0 0 12px;font-size:14px;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      background:#eaf0ff;border:1px solid #d6e2ff;
      padding:8px 12px;border-radius:999px;color:#243b6b;font-weight:700;font-size:13px;
    }
    .panel{
      background:var(--card);
      border:1px solid #e7e9f1;
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }

    /* âœ… ç²¾ç·»å¤–æ¡†ï¼šé›™å±¤é‚Šæ¡† + ç´°ç´‹ + å…§é™°å½± + äº®é‚Š */
    .frame{
      position:relative;
      border-radius:22px;
      padding:14px;
      background:
        radial-gradient(1200px 380px at 50% -30%, rgba(255,255,255,.95), rgba(255,255,255,.0) 60%),
        linear-gradient(180deg, #ffffff, #f7f8fc);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.9),
        inset 0 -1px 0 rgba(0,0,0,.05),
        0 10px 26px rgba(10,12,20,.10);
      overflow:hidden;
    }
    /* å¤–æ¡†ç´°ç´‹ */
    .frame:before{
      content:"";
      position:absolute;inset:0;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(0,0,0,.03) 0px,
          rgba(0,0,0,.03) 2px,
          rgba(0,0,0,0) 2px,
          rgba(0,0,0,0) 10px
        );
      opacity:.35;
      pointer-events:none;
      mask: linear-gradient(#000, #000);
    }
    /* å…§æ¡†ç·šï¼ˆç¬¬äºŒå±¤ï¼‰ */
    .frame:after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:16px;
      border:2px solid rgba(17,17,17,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.85);
      pointer-events:none;
    }

    /* Canvas æœ¬é«” */
    canvas{
      width:100%;
      height:auto;
      display:block;
      background: linear-gradient(180deg, #ffffff 0%, #ffffff 55%, #f3f4f8 56%, #f3f4f8 100%);
      border-radius:14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }

    .stats{
      display:flex;gap:14px;flex-wrap:wrap;
      font-size:16px;margin:10px 2px 0;color:var(--ink);
    }
    .stats b{font-weight:900;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{
      border:none;border-radius:14px;
      padding:10px 14px;
      font-size:16px;font-weight:900;
      background:#fff;color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
    }
    button.toggle{
      border:2px dashed rgba(0,0,0,.35);
      box-shadow:none;
    }
    .hint{color:var(--muted);margin-top:10px;font-size:14px;}
    .toast{
      color:#2a2a2a;
      margin-top:10px;
      font-size:13px;
      opacity:.85;
    }

    /* å°è¢å¹•æ›´èˆ’æœ */
    @media (max-width:520px){
      h1{font-size:32px;}
      .stats{font-size:15px;}
      button{font-size:15px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>ğŸ›µ Gravity Courier Run</h1>
        <p class="sub">é»ä¸€ä¸‹ / ç©ºç™½éµï¼šç¿»è½‰é‡åŠ›ï¼ˆåœ°æ¿â‡„å¤©èŠ±æ¿ï¼‰ã€‚æ‰‹æ©Ÿè¶…é †ã€‚</p>
      </div>
      <div class="chip">é»ä¸€ä¸‹å°±æœƒé–‹å§‹è·‘</div>
    </div>

    <div class="panel">
      <div class="frame">
        <canvas id="c" width="900" height="300"></canvas>
      </div>

      <div class="stats">
        <div>Score: <b id="score">0</b></div>
        <div>Best: <b id="best">0</b></div>
        <div>Combo: <b id="combo">0</b></div>
        <div>Speed: <b id="speed">1.0</b></div>
      </div>

      <div class="btns">
        <button id="restart">é‡æ–°é–‹å§‹</button>
        <button class="toggle" id="sfx">SFX: ON</button>
        <button class="toggle" id="bgm">BGM: OFF</button>
      </div>

      <div class="hint">å°æŠ€å·§ï¼šè²¼è‘—éšœç¤™ç‰©æ“¦éï¼ˆä¸è¦æ’åˆ°ï¼‰æœƒæ›´å®¹æ˜“ç´¯ç© Combo ğŸ•</div>
      <div class="toast" id="toast">æº–å‚™å¥½äº†ï½é»ç•«é¢é–‹å§‹ï¼</div>
    </div>
  </div>

<script>
(() => {
  // ===== Canvas
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha: false });

  // ===== UI
  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");
  const comboEl = document.getElementById("combo");
  const speedEl = document.getElementById("speed");
  const toastEl = document.getElementById("toast");
  const restartBtn = document.getElementById("restart");
  const sfxBtn = document.getElementById("sfx");
  const bgmBtn = document.getElementById("bgm");

  // ===== Storage
  const BEST_KEY = "gcr_best_v1";
  let best = Number(localStorage.getItem(BEST_KEY) || 0);
  bestEl.textContent = best;

  // ===== Game State
  const W = canvas.width, H = canvas.height;
  const groundY = 210;
  const ceilY = 60;

  let running = false;
  let gameOver = false;

  let score = 0;
  let combo = 0;
  let speed = 260;         // px/s (base)
  let speedMul = 1;        // UI speed display
  let gravityDir = +1;     // +1 towards ground, -1 towards ceiling

  // Player
  const player = {
    x: 160,
    y: groundY,
    w: 26,
    h: 26,
    vy: 0,
    snap: 1200, // snapping acceleration
  };

  // Obstacles
  const obs = [];
  let spawnT = 0;

  // ===== Audio (simple oscillator beeps)
  let audioCtx = null;
  let sfxOn = true;
  let bgmOn = false;
  let bgmNode = null;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended") audioCtx.resume();
  }
  function beep(freq=700, dur=0.06, type="square", vol=0.03){
    if(!sfxOn) return;
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }
  function startBgm(){
    if(!bgmOn) return;
    ensureAudio();
    stopBgm();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 110;
    g.gain.value = 0.015;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    bgmNode = o;

    // å°å°è„ˆå‹•
    let t = 0;
    const id = setInterval(() => {
      if(!bgmNode){ clearInterval(id); return; }
      t++;
      o.frequency.value = 110 + (t%8===0 ? 30 : 0);
    }, 160);
  }
  function stopBgm(){
    if(bgmNode){
      try{ bgmNode.stop(); }catch(e){}
      bgmNode = null;
    }
  }

  sfxBtn.addEventListener("click", () => {
    sfxOn = !sfxOn;
    sfxBtn.textContent = "SFX: " + (sfxOn ? "ON" : "OFF");
    beep(880, 0.05, "triangle", 0.03);
  });
  bgmBtn.addEventListener("click", () => {
    bgmOn = !bgmOn;
    bgmBtn.textContent = "BGM: " + (bgmOn ? "ON" : "OFF");
    ensureAudio();
    if(bgmOn) startBgm(); else stopBgm();
    beep(520, 0.05, "square", 0.03);
  });

  // ===== Helpers
  function reset(){
    running = false;
    gameOver = false;
    score = 0;
    combo = 0;
    speed = 260;
    speedMul = 1;
    gravityDir = +1;
    player.y = groundY;
    player.vy = 0;
    obs.length = 0;
    spawnT = 0;
    scoreEl.textContent = "0";
    comboEl.textContent = "0";
    speedEl.textContent = "1.0";
    toastEl.textContent = "æº–å‚™å¥½äº†ï½é»ç•«é¢é–‹å§‹ï¼";
  }

  function addObstacle(){
    // éš¨æ©Ÿé«˜åº¦ï¼šåœ°æ¿åˆº or å¤©èŠ±åˆº
    const top = Math.random() < 0.45;
    const w = 18 + Math.random()*8;
    const h = 24 + Math.random()*28;
    const y = top ? (ceilY - 2) : (groundY + player.h - h + 2);
    obs.push({
      x: W + 20,
      y,
      w,
      h,
      top,
      passed:false
    });
  }

  function flipGravity(){
    if(gameOver) return;
    ensureAudio();

    if(!running){
      running = true;
      toastEl.textContent = "è·‘èµ·ä¾†å•¦ï¼é»ä¸€ä¸‹ç¿»è½‰é‡åŠ›ï½";
      if(bgmOn) startBgm();
    }

    gravityDir *= -1;
    // çµ¦ä¸€å€‹å°è¡é‡ï¼Œè®“ç¿»è½‰æ›´ã€Œè„†ã€
    player.vy = gravityDir * 520;
    beep(gravityDir>0 ? 740 : 520, 0.06, "square", 0.035);
  }

  function doGameOver(){
    gameOver = true;
    running = false;
    stopBgm();
    beep(220, 0.12, "sawtooth", 0.03);
    toastEl.textContent = "æ’åˆ°äº†ï¼æŒ‰ã€Œé‡æ–°é–‹å§‹ã€å†ä¾†ä¸€å±€ ğŸ˜¼";
  }

  // ===== Input (æ‰‹æ©Ÿ/æ¡Œæ©Ÿ)
  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    flipGravity();
  }, {passive:false});

  window.addEventListener("keydown", (e) => {
    if(e.code === "Space"){
      e.preventDefault();
      flipGravity();
    }
    if(e.code === "Enter" && gameOver){
      reset();
    }
  });

  restartBtn.addEventListener("click", () => {
    reset();
    beep(660, 0.06, "triangle", 0.03);
  });

  // ===== Main Loop
  let last = performance.now();
  function loop(t){
    const dt = Math.min(0.033, (t - last)/1000);
    last = t;

    // Update
    if(running && !gameOver){
      // speed scaling
      score += dt * (60 * speedMul);
      speedMul = 1 + Math.min(1.2, score/1200);     // ä¸Šå‡åˆ° 2.2 å€ä¸Šé™
      speed = 260 * speedMul;

      // spawn
      spawnT -= dt;
      if(spawnT <= 0){
        addObstacle();
        // ç”Ÿæˆé–“éš”ï¼šè¶Šå¿«è¶ŠçŸ­ï¼Œä½†ä¿æŒå¯ç©
        spawnT = 0.65 + Math.random()*0.35 - Math.min(0.25, score/4000);
      }

      // physics
      const targetY = (gravityDir > 0) ? groundY : ceilY;
      const dy = targetY - player.y;
      player.vy += dy * player.snap * dt; // å¸é™„åˆ°åœ°æ¿/å¤©èŠ±æ¿
      player.vy *= 0.82;                  // é˜»å°¼
      player.y += player.vy * dt;

      // clamp
      player.y = Math.max(ceilY, Math.min(groundY, player.y));

      // obstacles move & collision
      for(const o of obs){
        o.x -= speed * dt;

        // pass score + combo
        if(!o.passed && o.x + o.w < player.x){
          o.passed = true;
          combo++;
          beep(880, 0.03, "triangle", 0.02);
        }

        // collision
        const hit =
          player.x < o.x + o.w &&
          player.x + player.w > o.x &&
          player.y < o.y + o.h &&
          player.y + player.h > o.y;

        if(hit){
          doGameOver();
          break;
        }
      }
      // clean
      while(obs.length && obs[0].x + obs[0].w < -40) obs.shift();

      // best update
      const sInt = Math.floor(score);
      scoreEl.textContent = String(sInt);
      comboEl.textContent = String(combo);
      speedEl.textContent = speedMul.toFixed(1);

      if(sInt > best){
        best = sInt;
        bestEl.textContent = String(best);
        localStorage.setItem(BEST_KEY, String(best));
      }
    }

    // Draw
    draw();

    requestAnimationFrame(loop);
  }

  function draw(){
    // background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    // subtle clouds
    ctx.fillStyle = "rgba(0,0,0,.06)";
    for(let i=0;i<4;i++){
      const cx = (i*220 + (performance.now()/30) % 900) % (W+140) - 60;
      const cy = 60 + i*18;
      roundRect(cx, cy, 70, 22, 12, true, false);
      roundRect(cx+24, cy-10, 46, 18, 10, true, false);
    }

    // floor/ceiling lines
    ctx.strokeStyle = "rgba(0,0,0,.12)";
    ctx.lineWidth = 2;
    line(0, groundY+player.h+6, W, groundY+player.h+6);
    line(0, ceilY-8, W, ceilY-8);

    // dashed track
    ctx.strokeStyle = "rgba(0,0,0,.10)";
    ctx.setLineDash([10,10]);
    ctx.lineWidth = 2;
    line(0, groundY+player.h+18, W, groundY+player.h+18);
    ctx.setLineDash([]);

    // obstacles
    for(const o of obs){
      ctx.fillStyle = "#111";
      roundRect(o.x, o.y, o.w, o.h, 6, true, false);
      // tiny highlight
      ctx.fillStyle = "rgba(255,255,255,.20)";
      roundRect(o.x+2, o.y+2, Math.max(2,o.w-4), 3, 2, true, false);
    }

    // player (ç°¡å–®å¯æ„›æ–¹å¡Š + å°é ­ç›”)
    ctx.fillStyle = "#111";
    roundRect(player.x, player.y, player.w, player.h, 7, true, false);
    // visor
    ctx.fillStyle = "rgba(255,255,255,.35)";
    roundRect(player.x+6, player.y+6, 12, 7, 4, true, false);

    // start overlay
    if(!running && !gameOver){
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.font = "900 32px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("TAP / SPACE", W/2, 145);
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.font = "700 16px system-ui";
      ctx.fillText("é»ä¸€ä¸‹é–‹å§‹ï¼Œä¸¦ç¿»è½‰é‡åŠ›", W/2, 172);
    }

    // game over overlay
    if(gameOver){
      ctx.fillStyle = "rgba(0,0,0,.60)";
      ctx.font = "900 40px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("GAME OVER", W/2, 150);
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.font = "700 16px system-ui";
      ctx.fillText("æŒ‰ Enter æˆ– é‡æ–°é–‹å§‹", W/2, 178);
    }
  }

  function line(x1,y1,x2,y2){
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
  }
  function roundRect(x,y,w,h,r,fill,stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  // boot
  reset();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
